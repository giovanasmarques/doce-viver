<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doceria Doce Viver</title>
    <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles/navegation.css">
    <link rel="stylesheet" href="styles/footer.css">
    <link rel="stylesheet" href="styles/cardapio.css">
    <link rel="stylesheet" href="styles/pedido.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>

<%- include('menu-header') %>

<h1>Cardápio</h1>

<div>
    <label>Filtrar por categoria:</label>
    <select id="categoriaFiltro" onchange="aplicarFiltros()">
        <option value="todos">Todos</option>
        <option value="Salgados">Salgados</option>
        <option value="Doces">Doces</option>
        <option value="Bebidas">Bebidas</option>
        <option value="Vegana">Vegana</option>
        <!-- ...outras opções -->
    </select>

    <label>Ordenar por preço:</label>
        <select id="precoFiltro" onchange="aplicarFiltros()">
            <option value="crescente">Crescente</option>
            <option value="decrescente">Decrescente</option>
        </select>
    </label>
</div>

<div id="salgados" class="categoria-item">
    <h2>Salgados</h2>
    <table id="table-salgados">
    
        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Salgados"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>
                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="doces" class="categoria-item">
    <h2>Doces</h2>
    <table id="table-doces">

        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Doces"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="bebidas" class="categoria-item">
    <h2>Bebidas</h2>
    <table id="table-bebidas">

        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Bebidas"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="vegana" class="categoria-item">
    <h2>Veganas</h2>
    <table id="table-veganos">
    
        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Vegana"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>

<br><br>
<div class="container">
    
    <% if (!user) { %> 
        <input type="hidden" name="total_pedido" id="valor-total-comanda-input" value="0"></input>
        <input type="hidden" name="pedidos_comanda" id="pedidos-comanda-input" value=""></input>
       <div class="container" id="pedidos-comanda"></div>
    <% } %>
    <p>Total: R$<span id="valor-total">0</span></p>
        
    <div style="display: none">
        <div class="container" id = "pedidos">
            
        </div>
    </div>
    

    <% if (user) { %> 
        <div class="content">
            <nav class="comprovante">
                <form action="/finalizarPedido"  method="POST">
                    <input type="hidden" name="total_pedido" id="valor-total-comanda-input" value="0"></input>
                    <input type="hidden" name="pedidos_comanda" id="pedidos-comanda-input" value=""></input>

                    <button class="btn open-modal" type="submit">Fechar comanda</button>
                </form>
                
                <!-- Botão que expande/colapsa o conteúdo -->
                <input type="checkbox" id="toggle" class="collapse-checkbox">
                <label class="btn collapse-button" for="toggle">Gerar Comprovante</label>
        
                <!-- Botão de download que permanece visível -->
                <button class="btn" onclick="gerarPDF()">Download comprovante</button>
        
                <!-- Conteúdo colapsável -->
                <div class="collapse-content" id="comprovante-pdf">
                    <div class="card-comprovante">
                        <div class="content">
                            <h3>Doceria Doce Viver</h3>
                            <h4>Obrigado pelo seu pedido!</h4>
                            <p class="tracado-baixo">Resumo do pedido</p>
                            <div class="container">
                                <div class="container" id="pedidos-comanda"></div>
                                
                                <h3 class="tracado-cima">Total: R$<span id="valor-total-comanda">0</span></h3>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
              

    <% } else { %>
        <div class="content">
            <nav class="comprovante">
                <h4>Faça login para fechar o seu pedido!</h4>
                <a class="btn" href="/login">Entrar</a>
            </nav>
        </div>
    <% } %>
</div>
<br><br>

<div class="modal <% if (status_pedido === 'Sucesso' | status_pedido === 'Falha') {%> show<% } %>">
    <div class="modal-content">
      <button class="close" onclick="document.querySelector('.modal').classList.remove('show')">&times;</button>
        <% if (status_pedido === 'Sucesso') {%>
            <h2>Comanda fechada com sucesso!</h2>
            <p>Clique em gerar comprovante ou fazer download para visualizar os itens do seu pedido!</p>
        <%} if (status_pedido === 'Falha') {%>
            <h2>Falha ao fechar comanda!</h2>
        <%}%>
      <button class='btn' onclick="document.querySelector('.modal').classList.remove('show')">Fechar</button>
    </div>
</div>

<footer>
    <div class="footer-basic">
        <div class="social">
            <a href="https://www.instagram.com/doce_viver_sh/?igsh=d21oNHhyb253dmZv"><i class="icon ion-social-instagram"></i></a>
            <a href="https://api.whatsapp.com/send?phone=seu-numero-de-telefone"><i class="icon ion-social-whatsapp"></i></a>
            <a href="https://maps.app.goo.gl/xmEBu6z6M5VTdjGd9"><i class="fa fa-map-marker"></i></a>
        </div>
        <ul class="list-inline">
            <li class="list-inline-item"><a href="/">Início</a></li>
            <li class="list-inline-item"><a href="sobreNos">Sobre nós</a></li>
            <li class="list-inline-item"><a href="cardapio">Cardápio</a></li>
            <li class="list-inline-item"><a href="galeria">Galeria</a></li>
            <li class="list-inline-item"><a href="ifsp">IFSP</a></li>
            <li class="list-inline-item"><a href="fazerPedido">Faça seu pedido</a></li>
        </ul>
        <p class="copyright">Doce Viver © 2024</p>
    </div>
</footer>

<script>
    // Função para adicionar um item ao pedido
    function aumentar(id, preco, nome) {
        const valorElemento = document.getElementById("valor-" + id);
        const quantidadeAtual = parseInt(valorElemento.getAttribute("value"));
        const novaQuantidade = quantidadeAtual + 1;

        // Atualiza o valor exibido no span
        valorElemento.textContent = novaQuantidade;
        valorElemento.setAttribute("value", novaQuantidade);

        calculaTotal(preco);
        adicionarNomeItem(nome, preco);
        salvarPedido(id, nome, preco, novaQuantidade);
    }

    // Função para remover um item do pedido
    function diminuir(id, preco, nome) {
        const valorElemento = document.getElementById("valor-" + id);
        const quantidadeAtual = parseInt(valorElemento.getAttribute("value"));
        if(quantidadeAtual > 0){
            const novaQuantidade = Math.max(quantidadeAtual - 1, 0); // Evita valores negativos

            // Atualiza o valor exibido no span
            valorElemento.textContent = novaQuantidade;
            valorElemento.setAttribute("value", novaQuantidade);

            calculaTotal(-preco);
            removeNomeItem(nome, preco);
            salvarPedido(id, nome, preco, novaQuantidade);
        }
    }

    // Função para calcular o total
    function calculaTotal(valorPedido) {
        const valorTotalElemento = document.getElementById("valor-total");
        const valorTotalComandaElemento = document.getElementById("valor-total-comanda");
        var input = document.getElementById('valor-total-comanda-input');

        let novoTotal = parseFloat(valorTotalElemento.textContent) + valorPedido;

        // Garante que o total nunca seja negativo
        novoTotal = Math.max(novoTotal, 0);
        valorTotalElemento.textContent = novoTotal.toFixed(2);
        if (valorTotalComandaElemento !== null) {
            valorTotalComandaElemento.textContent = novoTotal.toFixed(2);
            input.value = novoTotal;
        }

        // Salva o total atualizado na sessionStorage
        sessionStorage.setItem("valorTotal", novoTotal.toFixed(2));
    }

    // Função para salvar o pedido na sessionStorage
    function salvarPedido(id, nome, preco, quantidade) {
        const pedidos = JSON.parse(sessionStorage.getItem("pedidos")) || [];

        // Verifica se o item já existe no pedido
        const index = pedidos.findIndex((pedido) => pedido.id === id);
        if (index !== -1) {
            // Atualiza a quantidade se o item já existir
            if (quantidade > 0) {
                pedidos[index].quantidade = quantidade;
            } else {
                // Remove o item se a quantidade for zero
                pedidos.splice(index, 1);
            }
        } else if (quantidade > 0) {
            // Adiciona o item se não existir
            pedidos.push({ id, nome, preco, quantidade });
        }
        // Salva os pedidos atualizados na sessionStorage
        sessionStorage.setItem("pedidos", JSON.stringify(pedidos));
    }

    function adicionarNomeItem(nome, preco){
        const valorElemento = document.getElementById("pedidos");
        const valorElementoComanda = document.getElementById("pedidos-comanda");
        var input_text = document.getElementById("pedidos-comanda-input");

        valorElemento.innerHTML = valorElemento.innerHTML + "<p>" + nome + " (R$" + preco + ")</p>";
        valorElementoComanda.innerHTML = valorElementoComanda.innerHTML + "<p>" + nome + " (R$" + preco + ")</p>";
        input_text.value = input_text.value + nome + ", ";
    }

    function removeNomeItem(nome, preco){
        const valorElemento = document.getElementById("pedidos");
        const valorElementoComanda = document.getElementById("pedidos-comanda");
        const valorElementoComandaInput = document.getElementById("pedidos-comanda-input");
        const textRemove = "<p>" + nome + " (R$" + preco + ")</p>";
        const textRemoveInput = nome + ', ';
        
        if(valorElemento.innerHTML.includes(textRemove)){
            valorElemento.innerHTML = valorElemento.innerHTML.replace(textRemove, '');
        }
        
        if(valorElementoComanda.innerHTML.includes(textRemove)){
            valorElementoComanda.innerHTML = valorElementoComanda.innerHTML.replace(textRemove, '');
        }
        
        console.log(textRemoveInput);

        if(valorElementoComandaInput.value.includes(textRemoveInput)){
            valorElementoComandaInput.value = valorElementoComandaInput.value.replace(textRemoveInput, '');
        }

    }
    
    function gerarPDF() {
        let conteudo = "<style>.card-comprovante {display: block;width: 100%;background-color: #fff;border-radius: 6px;overflow: hidden;box-shadow: 0px 4px 6px rgba(0, 0, 0, .12);text-align: left;} .card-comprovante h4 {color: #F39562;} .tracado-baixo {border-bottom: 2px dotted #F39562;color: #F39562;padding-bottom: 15px;} .tracado-cima {border-top: 2px dotted #F39562;padding-top: 15px;} .image-comanda {height: 200px;overflow: hidden;} .image-comanda img {width: 100%;height: 100%;object-fit: cover;} .collapse-checkbox {display: none;} .collapse-button {display: inline-block;transition: background-color 0.3s;} .btn {display: inline-block;transition: background-color 0.3s;} .collapse-content {max-height: 0;overflow: hidden;transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;margin-top: 10px;} .collapse-checkbox:checked + .collapse-button + .btn + .collapse-content {max-height: 1000px;padding: 10px;} .card-comprovante {display: block;border: 1px solid #ddd;border-radius: 5px;background-color: #f8f9fa;padding: 10px;} .content h3, .content h4, .content p {margin: 10px 0;}</style>";
        conteudo = conteudo + document.getElementById("comprovante-pdf").innerHTML;
        const novaJanela = window.open('', '_blank', 'width=800,height=600');
        novaJanela.document.write(conteudo);
        novaJanela.document.close();
        novaJanela.print();
    }

    // Carregar pedidos salvos ao carregar a página
    window.onload = function () {
        console.log(sessionStorage.getItem("pedidos"));
        const pedidosSalvos = JSON.parse(sessionStorage.getItem("pedidos")) || [];
        const valorTotalSalvo = parseFloat(sessionStorage.getItem("valorTotal")) || 0;

        const pedidosContainer = document.getElementById("pedidos");
        const pedidosComandaContainer = document.getElementById("pedidos-comanda");
        const pedidosComandaContainerInput = document.getElementById("pedidos-comanda-input");

        // Atualiza os elementos da página
        pedidosSalvos.forEach((pedido) => {
            const valorElemento = document.getElementById("valor-" + pedido.id);
            if (valorElemento) {
                valorElemento.textContent = pedido.quantidade;
                valorElemento.setAttribute("value", pedido.quantidade);
            }

            for (let i = 0; i < pedido.quantidade; i++){
                const pedidoHTML = `<p>${pedido.nome} (R$${pedido.preco})</p>`;
                pedidosContainer.innerHTML += pedidoHTML;
                pedidosComandaContainer.innerHTML += pedidoHTML;
                pedidosComandaContainerInput.value += `${pedido.nome}, `;
            }
        });

        document.getElementById("valor-total").textContent = valorTotalSalvo.toFixed(2);
        
        if (document.getElementById("valor-total-comanda") !== null) {
            document.getElementById("valor-total-comanda").textContent = valorTotalSalvo.toFixed(2);
            document.getElementById('valor-total-comanda-input').value = valorTotalSalvo;
        }
    };
</script>

</body>
</html>
